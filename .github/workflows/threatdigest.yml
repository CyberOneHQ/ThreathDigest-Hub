name: ðŸ”„ ThreatDigest - Daily Cyber Feed Processing

on:
  schedule:
    - cron: '0 * * * *'  # Runs every hour
  workflow_dispatch:

jobs:
  run-threatdigest:
    runs-on: ubuntu-latest

    steps:
    # ==== 0. Checkout ====
    - name: â¬‡ï¸ Checkout Repository
      uses: actions/checkout@v3

    # ==== 1. Set up Python ====
    - name: ðŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # ==== 2. Install Dependencies ====
    - name: ðŸ”§ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    # ==== 3. Setup Environment ====
    - name: ðŸŒ Set up Environment Variables
      run: echo "OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}" >> $GITHUB_ENV

    # ==== 4. Execute Pipeline ====
    - name: ðŸš€ Run ThreatDigest Main
      run: python threatdigest_main.py

    # ==== 5. Commit and Push Outputs ====
    - name: ðŸ“¤ Commit and Push Output
      run: |
        git config user.name "github-actions"
        git config user.email "actions@github.com"
        git add data/output/*.json data/output/*.xml data/logs/
        git commit -m "ðŸ”„ Update ThreatDigest outputs [skip ci]" || echo "No changes to commit"
        git push https://x-access-token:${{ secrets.GITTOKEN }}@github.com/${{ github.repository }}.git HEAD:main
